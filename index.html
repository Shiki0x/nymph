<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NYMPH ‚Äì Dev UI</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      max-width: 820px;
      margin: auto;
      padding: 20px;
    }

    .muted { opacity: 0.7; font-size: 13px; }

    .card {
      background: #1b1b1b;
      padding: 14px;
      border-radius: 10px;
      margin: 12px 0;
      border: 1px solid #2a2a2a;
    }

    h1, h2 { margin: 0 0 10px 0; }

    label { display: block; margin-top: 10px; }

    input, textarea, button, select {
      width: 100%;
      margin: 6px 0;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #0f0f0f;
      color: #eee;
      box-sizing: border-box;
    }

    textarea { min-height: 70px; resize: vertical; }

    button {
      cursor: pointer;
      background: #4caf50;
      border: none;
      color: #111;
      font-weight: bold;
      margin-top: 10px;
    }

    .smallBtn {
      background: #2f80ed;
      color: #111;
      font-weight: bold;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .row > div { flex: 1; }

    .checkboxRow {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }

    ul { list-style: none; padding: 0; margin: 0; }

    li {
      background: #222;
      margin: 8px 0;
      padding: 12px;
      border-radius: 10px;
      line-height: 1.35;
      border: 1px solid #2d2d2d;
    }
  </style>
</head>

<body>
  <h1>NYMPH</h1>
  <p class="muted">Dev UI: Users + Profiles + Habits + Streaks + Links (with icons)</p>

  <!-- CREATE USER -->
  <div class="card">
    <h2>Create User</h2>

    <label>Username</label>
    <input id="usernameInput" placeholder="shiki" />

    <button class="smallBtn" onclick="createUser()">Create User</button>

    <p class="muted">After creating a user, IDs auto-fill across the page.</p>
  </div>

  <!-- UPDATE PROFILE -->
  <div class="card">
    <h2>Update Profile</h2>

    <label>User ID</label>
    <input id="profileUserIdInput" type="number" value="1" min="1" />

    <label>Display Name</label>
    <input id="displayNameInput" placeholder="Shiki.0" />

    <label>Bio</label>
    <textarea id="bioInput" placeholder="Building NYMPH. Daily habits + profile hub."></textarea>

    <button class="smallBtn" onclick="updateProfile()">Save Profile</button>

    <p class="muted" id="profileStatus"></p>
  </div>

  <!-- SHARE PROFILE -->
  <div class="card">
    <h2>Share Profile</h2>

    <label>Username</label>
    <input id="shareUsernameInput" placeholder="shiki" />

    <button class="smallBtn" onclick="copyShareLink()">Copy Share Link</button>

    <p class="muted" id="shareLinkPreview"></p>
  </div>

  <!-- PROFILE LINKS -->
  <div class="card">
    <h2>Profile Links</h2>

    <label>User ID</label>
    <input id="linksUserIdInput" type="number" value="1" min="1" />

    <label>Label</label>
    <input id="linkLabelInput" placeholder="GitHub" />

    <label>URL</label>
    <input id="linkUrlInput" placeholder="https://github.com/Shiki0x" />

    <label>Icon</label>
    <select id="linkIconInput">
      <option value="github">GitHub</option>
      <option value="youtube">YouTube</option>
      <option value="x">X</option>
      <option value="instagram">Instagram</option>
      <option value="tiktok">TikTok</option>
      <option value="twitch">Twitch</option>
      <option value="discord">Discord</option>
      <option value="website" selected>Website</option>
      <option value="link">Generic</option>
    </select>

    <button class="smallBtn" onclick="addLink()">Add Link</button>

    <p class="muted">These display on your public profile page.</p>

    <ul id="linksList"></ul>
  </div>

  <!-- LOG HABIT -->
  <div class="card">
    <h2>Log Habit</h2>

    <label>User ID</label>
    <input id="userIdInput" type="number" value="1" min="1" />

    <label>Habit</label>
    <input id="habitInput" placeholder="gym, study, meditate..." />

    <label>Category</label>
    <input id="categoryInput" placeholder="fitness, study, mental..." />

    <label>Notes</label>
    <textarea id="notesInput" placeholder="optional notes..."></textarea>

    <div class="checkboxRow">
      <input id="completedInput" type="checkbox" />
      <label for="completedInput" style="margin:0;">Completed</label>
    </div>

    <button onclick="logHabit()">Log Habit</button>
  </div>

  <!-- HABITS LIST -->
  <div class="card">
    <div class="row">
      <div>
        <h2>Habits</h2>
        <p class="muted">Shows habits + streak per habit</p>
      </div>
      <div style="text-align:right;">
        <button class="smallBtn" onclick="refreshHabits()">Refresh</button>
      </div>
    </div>

    <ul id="habitList"></ul>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    // Create User
    const usernameInput = document.getElementById("usernameInput");
    const userIdInput = document.getElementById("userIdInput");

    // Profile
    const profileUserIdInput = document.getElementById("profileUserIdInput");
    const displayNameInput = document.getElementById("displayNameInput");
    const bioInput = document.getElementById("bioInput");
    const profileStatus = document.getElementById("profileStatus");

    // Share
    const shareUsernameInput = document.getElementById("shareUsernameInput");
    const shareLinkPreview = document.getElementById("shareLinkPreview");

    // Links
    const linksUserIdInput = document.getElementById("linksUserIdInput");
    const linkLabelInput = document.getElementById("linkLabelInput");
    const linkUrlInput = document.getElementById("linkUrlInput");
    const linkIconInput = document.getElementById("linkIconInput");
    const linksList = document.getElementById("linksList");

    // Habits
    const habitInput = document.getElementById("habitInput");
    const categoryInput = document.getElementById("categoryInput");
    const notesInput = document.getElementById("notesInput");
    const completedInput = document.getElementById("completedInput");
    const habitList = document.getElementById("habitList");

    // -----------------------------
    // Create User
    // -----------------------------
    async function createUser() {
      const username = usernameInput.value.trim();
      if (!username) {
        alert("Username is required");
        return;
      }

      const url = new URL(`${API_BASE}/users`);
      url.searchParams.set("username", username);

      const res = await fetch(url.toString(), { method: "POST" });
      const data = await res.json();

      if (data.error) {
        alert(data.error);
        return;
      }

      alert(`User created: @${data.username} (id=${data.id})`);

      // Auto-fill IDs across UI
      userIdInput.value = data.id;
      profileUserIdInput.value = data.id;
      linksUserIdInput.value = data.id;

      // Default share username
      shareUsernameInput.value = data.username;

      usernameInput.value = "";

      refreshLinks();
      refreshHabits();
    }

    // -----------------------------
    // Update Profile
    // -----------------------------
    async function updateProfile() {
      const userId = profileUserIdInput.value;
      const displayName = displayNameInput.value.trim();
      const bio = bioInput.value.trim();

      const url = new URL(`${API_BASE}/users/profile`);
      url.searchParams.set("user_id", userId);

      if (displayName) url.searchParams.set("display_name", displayName);
      if (bio) url.searchParams.set("bio", bio);

      const res = await fetch(url.toString(), { method: "PATCH" });
      const data = await res.json();

      profileStatus.textContent = data.message ? "Profile saved ‚úÖ" : "Profile update failed";
      setTimeout(() => (profileStatus.textContent = ""), 3000);
    }

    // -----------------------------
    // Share Link
    // -----------------------------
    function copyShareLink() {
      const username = shareUsernameInput.value.trim();
      if (!username) {
        alert("Enter a username to share");
        return;
      }

      const link = `http://127.0.0.1:5500/profile.html?username=${encodeURIComponent(username)}`;
      navigator.clipboard.writeText(link);

      shareLinkPreview.textContent = `Copied: ${link}`;
    }

    // -----------------------------
    // Links (add/list/delete)
    // -----------------------------
    async function addLink() {
      const userId = linksUserIdInput.value;
      const label = linkLabelInput.value.trim();
      const url = linkUrlInput.value.trim();
      const icon = linkIconInput.value;

      if (!label || !url) {
        alert("Label and URL are required");
        return;
      }

      const apiUrl = new URL(`${API_BASE}/links`);
      apiUrl.searchParams.set("user_id", userId);
      apiUrl.searchParams.set("label", label);
      apiUrl.searchParams.set("url", url);
      apiUrl.searchParams.set("icon", icon);

      await fetch(apiUrl.toString(), { method: "POST" });

      linkLabelInput.value = "";
      linkUrlInput.value = "";

      refreshLinks();
    }

    async function deleteLink(linkId) {
      await fetch(`${API_BASE}/links/${linkId}`, { method: "DELETE" });
      refreshLinks();
    }

    async function refreshLinks() {
      const userId = linksUserIdInput.value;
      const res = await fetch(`${API_BASE}/links?user_id=${userId}`);
      const data = await res.json();

      linksList.innerHTML = "";

      if (!data.length) {
        const li = document.createElement("li");
        li.textContent = "No links yet.";
        linksList.appendChild(li);
        return;
      }

      data.forEach(link => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <strong>${link.label}</strong> <span class="muted">(${link.icon})</span><br/>
              <span class="muted">${link.url}</span>
            </div>
            <button class="smallBtn" style="width:auto;" onclick="deleteLink(${link.id})">Delete</button>
          </div>
        `;
        linksList.appendChild(li);
      });
    }

    // -----------------------------
    // Log Habit
    // -----------------------------
    async function logHabit() {
      const userId = userIdInput.value;
      const habit = habitInput.value.trim();
      const completed = completedInput.checked;
      const category = categoryInput.value.trim();
      const notes = notesInput.value.trim();

      if (!habit) {
        alert("Habit is required");
        return;
      }

      const url = new URL(`${API_BASE}/log-habit`);
      url.searchParams.set("user_id", userId);
      url.searchParams.set("habit", habit);
      url.searchParams.set("completed", completed);

      if (category) url.searchParams.set("category", category);
      if (notes) url.searchParams.set("notes", notes);

      await fetch(url.toString(), { method: "POST" });

      habitInput.value = "";
      categoryInput.value = "";
      notesInput.value = "";
      completedInput.checked = false;

      refreshHabits();
    }

    // -----------------------------
    // Refresh Habits + Streaks
    // -----------------------------
    async function refreshHabits() {
      const userId = userIdInput.value;

      const [habitsRes, streaksRes] = await Promise.all([
        fetch(`${API_BASE}/habits?user_id=${userId}`),
        fetch(`${API_BASE}/streaks?user_id=${userId}`)
      ]);

      const habits = await habitsRes.json();
      const streaks = await streaksRes.json();

      const streakMap = {};
      streaks.forEach(s => { streakMap[s.habit] = s.streak; });

      habitList.innerHTML = "";

      if (!Array.isArray(habits) || habits.length === 0) {
        const li = document.createElement("li");
        li.textContent = "No habits yet. Log your first one above.";
        habitList.appendChild(li);
        return;
      }

      habits.forEach(item => {
        const li = document.createElement("li");

        const category = item.category ? ` (${item.category})` : "";
        const notes = item.notes ? ` ‚Äî ${item.notes}` : "";
        const status = item.completed ? "‚úîÔ∏è" : "‚ùå";
        const streak = streakMap[item.habit] ?? 0;

        li.textContent = `${status} ${item.habit}${category}${notes}   üî• Streak: ${streak}`;
        habitList.appendChild(li);
      });
    }

    // Initial load
    refreshLinks();
    refreshHabits();
  </script>
</body>
</html>
