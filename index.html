<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NYMPH Dev UI</title>
  <style>
    body { font-family: system-ui, Arial; background:#070a0f; color:#e7eef7; margin:0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 18px 60px; }
    h1 { margin: 0 0 8px; font-size: 34px; }
    h2 { margin: 10px 0 6px; }
    h3 { margin: 18px 0 6px; }
    .muted { color:#9bb0c7; font-size: 13px; }
    .card { background:#101723; border:1px solid #1b2a3e; border-radius:16px; padding:16px; margin:14px 0; }
    label { display:block; font-size: 13px; color:#cfe0f3; margin-top: 10px; }
    input, select, textarea {
      width: 100%; box-sizing: border-box;
      background:#0c1220; border:1px solid #1b2a3e; color:#e7eef7;
      border-radius: 12px; padding: 10px; margin-top: 6px;
    }
    textarea { min-height: 120px; resize: vertical; }
    button {
      margin-top: 12px;
      background:#2a7cff; color:white; border:none;
      padding: 10px 14px; border-radius: 12px; font-weight: 800;
      cursor:pointer;
    }
    button:hover { filter: brightness(1.05); }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; border:1px solid #1b2a3e; color:#9bb0c7; font-size:12px; }
    ul { margin: 8px 0 0 18px; }
    li { margin: 6px 0; }
    .danger { background:#ff3b3b; }
    .mini { padding: 7px 10px; font-size: 12px; border-radius: 10px; margin-left: 8px; }
    .codehint { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; color:#9bb0c7; }
    a { color:#9bd1ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>NYMPH (Dev UI)</h1>
    <div class="muted">Local admin panel. Backend: <span class="codehint">127.0.0.1:8000</span> · Frontend: <span class="codehint">127.0.0.1:5500</span></div>

    <!-- USER -->
    <div class="card">
      <div class="pill">Step 1</div>
      <h2>User</h2>
      <div class="muted">Create/update your user (required so habits/links/cards save to the right profile).</div>

      <label>Username</label>
      <input id="usernameInput" placeholder="shiki" value="shiki" />

      <label>Display Name</label>
      <input id="displayNameInput" placeholder="SHIKI" value="SHIKI" />

      <label>Bio</label>
      <input id="bioInput" placeholder="Building NYMPH." value="Building NYMPH." />

      <button onclick="saveUser()">Save/Update User</button>
      <div class="muted" id="userStatus" style="margin-top:10px;"></div>
    </div>

    <!-- HABITS -->
    <div class="card">
      <div class="pill">Step 2</div>
      <h2>Log Habit</h2>

      <label>Habit</label>
      <input id="habitInput" placeholder="gym" />

      <div class="row">
        <div>
          <label>Category</label>
          <input id="categoryInput" placeholder="health" />
        </div>
        <div>
          <label>Completed</label>
          <select id="completedInput">
            <option value="true">true</option>
            <option value="false" selected>false</option>
          </select>
        </div>
      </div>

      <label>Notes</label>
      <input id="notesInput" placeholder="workout once a day" />

      <button onclick="logHabit()">Log Habit</button>

      <h3>Recent Habits</h3>
      <ul id="habitList"></ul>
    </div>

    <!-- LINKS -->
    <div class="card">
      <div class="pill">Step 3</div>
      <h2>Add Link</h2>

      <label>Label</label>
      <input id="linkLabelInput" placeholder="GitHub" />

      <label>URL</label>
      <input id="linkUrlInput" placeholder="https://github.com/Shiki0x" />

      <label>Icon key (optional)</label>
      <div class="muted">Examples: <span class="codehint">github</span>, <span class="codehint">youtube</span>, <span class="codehint">website</span></div>
      <input id="linkIconInput" placeholder="github" />

      <button onclick="addLink()">Add Link</button>

      <h3>Links</h3>
      <ul id="linkList"></ul>
    </div>

    <!-- CARDS -->
    <div class="card">
      <div class="pill">Phase 2</div>
      <h2>Profile Cards</h2>
      <div class="muted">
        Cards show up on your public profile page:
        <span class="codehint">profile.html?username=...</span>
      </div>

      <div class="row">
        <div>
          <label>Card Type</label>
          <select id="cardTypeInput" onchange="fillCardTemplate()">
            <option value="quote">quote</option>
            <option value="list">list</option>
            <option value="anime_grid">anime_grid</option>
            <option value="anime_tiles">anime_tiles (NEW)</option>
            <option value="text">text</option>
          </select>
        </div>
        <div>
          <label>Card Title</label>
          <input id="cardTitleInput" placeholder="Anime Favorites" />
        </div>
      </div>

      <label>Card Content (JSON)</label>
      <textarea id="cardContentInput"></textarea>
      <div class="muted">
        Must be valid JSON. If you’re unsure, click <b>Use Template</b>.
      </div>

      <label style="margin-top:10px;">
        <input type="checkbox" id="cardPublicInput" checked />
        Public (shows on profile)
      </label>

      <button onclick="addCard()">Create Card</button>
      <button class="mini" onclick="fillCardTemplate()">Use Template</button>

      <h3>Your Cards</h3>
      <ul id="cardList"></ul>
    </div>

    <!-- SHARE -->
    <div class="card">
      <h2>Share</h2>
      <div class="muted">Open your public profile (frontend server must be running).</div>
      <div id="shareLinks" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";
    const FRONTEND_BASE = "http://127.0.0.1:5500";

    let currentUser = null;

    // -----------------------------
    // User
    // -----------------------------
    async function saveUser() {
      const username = document.getElementById("usernameInput").value.trim();
      const displayName = document.getElementById("displayNameInput").value.trim();
      const bio = document.getElementById("bioInput").value.trim();

      const url = new URL(`${API_BASE}/users/upsert`);
      url.searchParams.set("username", username);
      url.searchParams.set("display_name", displayName);
      url.searchParams.set("bio", bio);

      const res = await fetch(url, { method: "POST" });
      const data = await res.json();

      if (data.error) {
        document.getElementById("userStatus").textContent = data.error;
        return;
      }

      currentUser = data;

      document.getElementById("userStatus").textContent =
        `Saved user: ${data.display_name} (@${data.username}) [id=${data.id}]`;

      // Share link preview
      document.getElementById("shareLinks").innerHTML = `
        <div>Profile:
          <a href="${FRONTEND_BASE}/profile.html?username=${encodeURIComponent(data.username)}" target="_blank">
            Open
          </a>
        </div>
      `;

      await refreshHabits();
      await refreshLinks();
      await refreshCards();
    }

    // -----------------------------
    // Habits
    // -----------------------------
    async function logHabit() {
      if (!currentUser) return alert("Save/Update User first.");

      const habit = document.getElementById("habitInput").value.trim();
      const category = document.getElementById("categoryInput").value.trim();
      const notes = document.getElementById("notesInput").value.trim();
      const completed = document.getElementById("completedInput").value === "true";

      if (!habit) return alert("Habit cannot be empty.");

      const url = new URL(`${API_BASE}/log-habit`);
      url.searchParams.set("user_id", currentUser.id);
      url.searchParams.set("habit", habit);
      url.searchParams.set("completed", completed);
      if (category) url.searchParams.set("category", category);
      if (notes) url.searchParams.set("notes", notes);

      await fetch(url, { method: "POST" });

      document.getElementById("habitInput").value = "";
      document.getElementById("categoryInput").value = "";
      document.getElementById("notesInput").value = "";
      document.getElementById("completedInput").value = "false";

      await refreshHabits();
    }

    async function refreshHabits() {
      if (!currentUser) return;

      const res = await fetch(`${API_BASE}/habits?user_id=${currentUser.id}`);
      const habits = await res.json();

      const list = document.getElementById("habitList");
      list.innerHTML = "";

      if (!habits.length) {
        const li = document.createElement("li");
        li.className = "muted";
        li.textContent = "No habits yet.";
        list.appendChild(li);
        return;
      }

      habits.slice(0, 8).forEach(h => {
        const li = document.createElement("li");
        const status = h.completed ? "✔️" : "❌";
        const cat = h.category ? ` (${h.category})` : "";
        const note = h.notes ? ` — ${h.notes}` : "";
        li.textContent = `${status} ${h.habit}${cat}${note}`;
        list.appendChild(li);
      });
    }

    // -----------------------------
    // Links
    // -----------------------------
    async function addLink() {
      if (!currentUser) return alert("Save/Update User first.");

      const label = document.getElementById("linkLabelInput").value.trim();
      const urlValue = document.getElementById("linkUrlInput").value.trim();
      const icon = document.getElementById("linkIconInput").value.trim() || "link";

      if (!label || !urlValue) return alert("Label + URL are required.");

      const url = new URL(`${API_BASE}/links/add`);
      url.searchParams.set("user_id", currentUser.id);
      url.searchParams.set("label", label);
      url.searchParams.set("url", urlValue);
      url.searchParams.set("icon", icon);

      await fetch(url, { method: "POST" });

      document.getElementById("linkLabelInput").value = "";
      document.getElementById("linkUrlInput").value = "";
      document.getElementById("linkIconInput").value = "";

      await refreshLinks();
    }

    async function refreshLinks() {
      if (!currentUser) return;

      const res = await fetch(`${API_BASE}/links?user_id=${currentUser.id}`);
      const links = await res.json();

      const list = document.getElementById("linkList");
      list.innerHTML = "";

      if (!links.length) {
        const li = document.createElement("li");
        li.className = "muted";
        li.textContent = "No links yet.";
        list.appendChild(li);
        return;
      }

      links.forEach(l => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="muted">${l.icon}</span> <b>${l.label}</b> — ${l.url}`;
        list.appendChild(li);
      });
    }

    // -----------------------------
    // Cards
    // -----------------------------
    function fillCardTemplate() {
      const type = document.getElementById("cardTypeInput").value;

      let title = "Card";
      let content = {};

      if (type === "quote") {
        title = "Quote";
        content = { text: "Discipline beats motivation.", author: "— NYMPH" };
      }

      if (type === "list") {
        title = "Hobbies";
        content = { items: ["Gaming", "Hiking", "Singing"] };
      }

      if (type === "anime_grid") {
        title = "Anime";
        content = { items: [{ name: "Attack on Titan", note: "Peak story", url: "https://example.com" }] };
      }

      // ✅ NEW template for anime tiles
      if (type === "anime_tiles") {
        title = "Anime Favorites";
        content = {
          items: [
            {
              name: "Attack on Titan",
              status: "Completed",
              note: "Insane story + soundtrack",
              link: "https://myanimelist.net/anime/16498/Shingeki_no_Kyojin"
            },
            {
              name: "Jujutsu Kaisen",
              status: "Watching",
              note: "Gojo is HIM",
              link: "https://myanimelist.net/anime/40748/Jujutsu_Kaisen"
            }
          ]
        };
      }

      if (type === "text") {
        title = "Thought";
        content = { text: "Building NYMPH right now." };
      }

      document.getElementById("cardTitleInput").value = title;
      document.getElementById("cardContentInput").value = JSON.stringify(content, null, 2);
    }

    async function addCard() {
      if (!currentUser) return alert("Save/Update User first.");

      const type = document.getElementById("cardTypeInput").value;
      const title = document.getElementById("cardTitleInput").value.trim();
      const contentText = document.getElementById("cardContentInput").value.trim();
      const isPublic = document.getElementById("cardPublicInput").checked;

      if (!title) return alert("Card title is required.");
      if (!contentText) return alert("Card content is required.");

      // Validate JSON before sending
      try {
        JSON.parse(contentText);
      } catch {
        return alert("Card Content is not valid JSON. Click 'Use Template' to start clean.");
      }

      const url = new URL(`${API_BASE}/cards/add`);
      url.searchParams.set("user_id", currentUser.id);
      url.searchParams.set("type", type);
      url.searchParams.set("title", title);
      url.searchParams.set("content_json", contentText);
      url.searchParams.set("is_public", isPublic);

      const res = await fetch(url, { method: "POST" });
      if (!res.ok) {
        const err = await res.text();
        return alert("Failed to create card:\n" + err);
      }

      await refreshCards();
    }

    async function refreshCards() {
      if (!currentUser) return;

      const res = await fetch(`${API_BASE}/cards/by-user?user_id=${currentUser.id}`);
      const cards = await res.json();

      const list = document.getElementById("cardList");
      list.innerHTML = "";

      if (!cards.length) {
        const li = document.createElement("li");
        li.className = "muted";
        li.textContent = "No cards yet. Create your first one above.";
        list.appendChild(li);
        return;
      }

      cards.forEach(card => {
        const li = document.createElement("li");
        const previewRaw = JSON.stringify(card.content);
        const preview = previewRaw.slice(0, 90) + (previewRaw.length > 90 ? "..." : "");

        li.innerHTML = `
          <b>${card.title}</b>
          <span class="muted">(${card.type})</span>
          <span class="muted"> public=${card.is_public}</span>
          <span class="muted"> — ${preview}</span>
          <button class="mini danger" onclick="deleteCard(${card.id})">Delete</button>
        `;
        list.appendChild(li);
      });
    }

    async function deleteCard(cardId) {
      if (!currentUser) return;

      const ok = confirm("Delete this card?");
      if (!ok) return;

      const url = new URL(`${API_BASE}/cards/delete`);
      url.searchParams.set("user_id", currentUser.id);
      url.searchParams.set("card_id", cardId);

      const res = await fetch(url, { method: "DELETE" });
      if (!res.ok) {
        const err = await res.text();
        return alert("Delete failed:\n" + err);
      }

      await refreshCards();
    }

    // Start with a template so you're not staring at empty JSON
    fillCardTemplate();
  </script>
</body>
</html>
