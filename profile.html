<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NYMPH Profile</title>
  <style>
    body { font-family: system-ui, Arial; background:#070a0f; color:#e7eef7; margin:0; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 18px 60px; }
    .hero { text-align:center; margin-top: 10px; }
    h1 { margin: 0; font-size: 44px; letter-spacing: 0.5px; }
    .handle { color:#9bb0c7; margin-top:6px; }
    .bio { color:#cfe0f3; margin: 14px auto 0; max-width: 640px; }

    .sectionTitle { margin: 18px 0 10px; font-size: 18px; color:#cfe0f3; }
    .card { background:#101723; border:1px solid #1b2a3e; border-radius:16px; padding:16px; margin:14px 0; }
    .muted { color:#9bb0c7; font-size: 13px; }

    /* Links */
    .linksWrap { display:flex; flex-direction:column; gap:10px; }
    a.linkBtn {
      display:flex; align-items:center; gap:10px;
      padding:12px; border-radius:14px;
      background:#0c1220; border:1px solid #1b2a3e;
      color:#e7eef7; text-decoration:none; font-weight:700;
    }
    a.linkBtn:hover { border-color:#2a7cff; }
    .iconBox { width: 28px; text-align:center; font-size:18px; }

    /* Habits */
    ul { margin: 8px 0 0 18px; }
    li { margin: 6px 0; }

    /* Cards */
    .tileGrid { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top: 10px; }
    .tile { background:#0c1220; border:1px solid #1b2a3e; border-radius:14px; padding:12px; }
    .tileTitle { font-weight: 800; }
    .tileNote { color:#9bb0c7; margin-top: 6px; font-size: 13px; }
    .quoteText { font-size: 18px; line-height: 1.5; }
    .quoteAuthor { margin-top: 8px; }

    @media (min-width: 900px) {
      .tileGrid { grid-template-columns: repeat(4, 1fr); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1 id="displayName">NYMPH</h1>
      <div class="handle" id="handle">@username</div>
      <div class="bio" id="bio"></div>
    </div>

    <!-- LINKS -->
    <div class="card">
      <div class="sectionTitle">Links</div>
      <div id="linksBox" class="muted">Loading links...</div>
    </div>

    <!-- RECENT HABITS -->
    <div class="card">
      <div class="sectionTitle">Recent Habits</div>
      <div class="muted">Latest logs (last 8)</div>
      <ul id="habitList"></ul>
    </div>

    <!-- PROFILE CARDS -->
    <div id="cards"></div>

    <p class="muted" style="text-align:center;margin-top:26px;">NYMPH ‚Äî personal growth profile</p>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    const ICONS = {
      github: "üêô",
      youtube: "‚ñ∂Ô∏è",
      x: "ùïè",
      instagram: "üì∏",
      tiktok: "üéµ",
      twitch: "üü£",
      discord: "üí¨",
      website: "üåê",
      link: "üîó"
    };

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const username = (getQueryParam("username") || "").trim();

    const displayNameEl = document.getElementById("displayName");
    const handleEl = document.getElementById("handle");
    const bioEl = document.getElementById("bio");
    const linksBox = document.getElementById("linksBox");
    const habitList = document.getElementById("habitList");
    const cardsEl = document.getElementById("cards");

    async function loadProfile() {
      if (!username) {
        displayNameEl.textContent = "No username provided";
        handleEl.textContent = "Use ?username=shiki";
        linksBox.textContent = "";
        return;
      }

      // 1) Load user
      const userUrl = new URL(`${API_BASE}/users/by-username`);
      userUrl.searchParams.set("username", username);

      const userRes = await fetch(userUrl);
      const user = await userRes.json();

      if (user.error) {
        displayNameEl.textContent = "User not found";
        handleEl.textContent = `@${username}`;
        linksBox.textContent = "";
        return;
      }

      displayNameEl.textContent = user.display_name;
      handleEl.textContent = `@${user.username}`;
      bioEl.textContent = user.bio || "";

      // 2) Load links + habits + cards in parallel
      await Promise.all([
        loadLinks(user.id),
        loadHabits(user.id),
        loadCards(user.username)
      ]);
    }

    async function loadLinks(userId) {
      const res = await fetch(`${API_BASE}/links?user_id=${userId}`);
      const links = await res.json();

      linksBox.innerHTML = "";
      linksBox.classList.remove("muted");

      if (!Array.isArray(links) || links.length === 0) {
        linksBox.textContent = "No links yet.";
        linksBox.classList.add("muted");
        return;
      }

      const wrap = document.createElement("div");
      wrap.className = "linksWrap";

      links.forEach(link => {
        const a = document.createElement("a");
        a.href = link.url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.className = "linkBtn";

        const iconKey = (link.icon || "link").toLowerCase();
        const icon = ICONS[iconKey] || "üîó";

        a.innerHTML = `
          <div class="iconBox">${icon}</div>
          <div>${link.label}</div>
        `;

        wrap.appendChild(a);
      });

      linksBox.appendChild(wrap);
    }

    async function loadHabits(userId) {
      const res = await fetch(`${API_BASE}/habits?user_id=${userId}`);
      const habits = await res.json();

      habitList.innerHTML = "";

      if (!Array.isArray(habits) || habits.length === 0) {
        const li = document.createElement("li");
        li.className = "muted";
        li.textContent = "No habits logged yet.";
        habitList.appendChild(li);
        return;
      }

      habits.slice(0, 8).forEach(h => {
        const li = document.createElement("li");
        const status = h.completed ? "‚úîÔ∏è" : "‚ùå";
        const cat = h.category ? ` (${h.category})` : "";
        const note = h.notes ? ` ‚Äî ${h.notes}` : "";
        li.textContent = `${status} ${h.habit}${cat}${note}`;
        habitList.appendChild(li);
      });
    }

    async function loadCards(username) {
      const cardsUrl = new URL(`${API_BASE}/cards`);
      cardsUrl.searchParams.set("username", username);

      const res = await fetch(cardsUrl);
      const cards = await res.json();

      cardsEl.innerHTML = "";

      if (!Array.isArray(cards) || cards.length === 0) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.innerHTML = `<div class="sectionTitle">Cards</div><div class="muted">No cards yet.</div>`;
        cardsEl.appendChild(empty);
        return;
      }

      cards.forEach(card => {
        const box = document.createElement("div");
        box.className = "card";

        const title = document.createElement("div");
        title.className = "sectionTitle";
        title.textContent = card.title;
        box.appendChild(title);

        // Quote card
        if (card.type === "quote") {
          const text = document.createElement("div");
          text.className = "quoteText";
          text.textContent = `‚Äú${card.content.text || ""}‚Äù`;
          box.appendChild(text);

          if (card.content.author) {
            const author = document.createElement("div");
            author.className = "muted quoteAuthor";
            author.textContent = card.content.author;
            box.appendChild(author);
          }
        }

        // List card
        if (card.type === "list") {
          const ul = document.createElement("ul");
          (card.content.items || []).forEach(item => {
            const li = document.createElement("li");
            li.textContent = item;
            ul.appendChild(li);
          });
          box.appendChild(ul);
        }

        // Anime grid
        if (card.type === "anime_grid") {
          const grid = document.createElement("div");
          grid.className = "tileGrid";

          (card.content.items || []).forEach(item => {
            const tile = document.createElement("div");
            tile.className = "tile";

            const t = document.createElement("div");
            t.className = "tileTitle";
            t.textContent = item.name || "Untitled";
            tile.appendChild(t);

            if (item.note) {
              const n = document.createElement("div");
              n.className = "tileNote";
              n.textContent = item.note;
              tile.appendChild(n);
            }

            if (item.url) {
              const a = document.createElement("a");
              a.href = item.url;
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.style.display = "inline-block";
              a.style.marginTop = "10px";
              a.textContent = "Link";
              tile.appendChild(a);
            }

            grid.appendChild(tile);
          });

          box.appendChild(grid);
        }

        // Unknown type fallback
        if (!["quote", "list", "anime_grid"].includes(card.type)) {
          const pre = document.createElement("pre");
          pre.textContent = JSON.stringify(card.content, null, 2);
          box.appendChild(pre);
        }

        cardsEl.appendChild(box);
      });
    }

    loadProfile();
  </script>
</body>
</html>
